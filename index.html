<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Casa Nova</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body>

<div id="auth-overlay" class="auth-overlay">
    <div class="auth-box">
        <h2><i class="fas fa-home"></i> Casa Nova</h2>
        <p id="auth-msg">Faça login para continuar</p>
        
        <div class="auth-inputs">
            <input type="email" id="auth-email" placeholder="E-mail" class="auth-input">
            <input type="password" id="auth-pass" placeholder="Senha" class="auth-input">
        </div>

        <button id="btn-login-email" class="btn-auth-action">Entrar</button>
        <button id="btn-register-email" class="btn-auth-action" style="display:none;">Cadastrar</button>
        
        <div class="divider">ou</div>

        <button id="btn-login-google" class="btn-google">
            <i class="fab fa-google"></i> Entrar com Google
        </button>

        <div class="auth-toggle">
            <span id="toggle-text">Não tem conta?</span>
            <a href="#" id="toggle-auth">Criar conta</a>
        </div>
    </div>
</div>

<header>
    <h1><i class="fas fa-home"></i> Gestão de Casa</h1>
    <div id="user-info" style="display:none; align-items:center; gap:10px;">
        <span id="user-name" style="color:var(--accent-color); font-weight:bold;">Usuário</span>
        <button onclick="logout()" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Sair</button>
    </div>
</header>

<div id="app-content" style="display:none;">
    <div class="dashboard-area">
        <p style="text-align:center; padding:20px; color:#fff;">(Conteúdo do App Carregado)</p>
    </div>
    <div class="container" id="main-container"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getAuth, 
        GoogleAuthProvider, 
        signInWithPopup, 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword, 
        signOut, 
        onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD4cf7vaS03FfF-Yq8qFAeXh7xFqHjTZvY",
        authDomain: "gerenciador-casa-nova-995be.firebaseapp.com",
        projectId: "gerenciador-casa-nova-995be",
        storageBucket: "gerenciador-casa-nova-995be.firebasestorage.app",
        messagingSenderId: "445897682000",
        appId: "1:445897682000:web:6b715606cd666653c3b555",
        measurementId: "G-23EQ6DCPEJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // Exporta para o script.js
    window.db = db;
    window.auth = auth;
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.currentUser = null;

    // --- ELEMENTOS DA UI ---
    const emailInput = document.getElementById('auth-email');
    const passInput = document.getElementById('auth-pass');
    const btnLoginEmail = document.getElementById('btn-login-email');
    const btnRegisterEmail = document.getElementById('btn-register-email');
    const toggleLink = document.getElementById('toggle-auth');
    const toggleText = document.getElementById('toggle-text');
    const authMsg = document.getElementById('auth-msg');

    let isLoginMode = true;

    // --- ALTERNAR MODO LOGIN / CADASTRO ---
    toggleLink.addEventListener('click', (e) => {
        e.preventDefault();
        isLoginMode = !isLoginMode;
        
        if (isLoginMode) {
            authMsg.textContent = "Faça login para continuar";
            btnLoginEmail.style.display = "block";
            btnRegisterEmail.style.display = "none";
            toggleText.textContent = "Não tem conta?";
            toggleLink.textContent = "Criar conta";
        } else {
            authMsg.textContent = "Crie sua conta para começar";
            btnLoginEmail.style.display = "none";
            btnRegisterEmail.style.display = "block";
            toggleText.textContent = "Já tem conta?";
            toggleLink.textContent = "Fazer login";
        }
    });

    // --- LOGIN COM EMAIL ---
    btnLoginEmail.addEventListener('click', () => {
        const email = emailInput.value;
        const pass = passInput.value;
        signInWithEmailAndPassword(auth, email, pass)
            .catch((error) => alert("Erro ao entrar: " + error.message));
    });

    // --- CADASTRO COM EMAIL (NOVO) ---
    btnRegisterEmail.addEventListener('click', () => {
        const email = emailInput.value;
        const pass = passInput.value;
        createUserWithEmailAndPassword(auth, email, pass)
            .then((userCredential) => {
                console.log("Usuário criado:", userCredential.user);
                // O onAuthStateChanged vai lidar com o resto automaticamente
            })
            .catch((error) => {
                if (error.code === 'auth/email-already-in-use') {
                    alert("Esse e-mail já está sendo usado.");
                } else if (error.code === 'auth/weak-password') {
                    alert("A senha deve ter pelo menos 6 caracteres.");
                } else {
                    alert("Erro ao cadastrar: " + error.message);
                }
            });
    });

    // --- LOGIN COM GOOGLE ---
    document.getElementById('btn-login-google').addEventListener('click', () => {
        signInWithPopup(auth, provider).catch((error) => alert("Erro Google: " + error.message));
    });

    // --- LOGOUT ---
    window.logout = () => {
        signOut(auth).then(() => location.reload());
    };

    // --- MONITORAMENTO DE ESTADO ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            window.currentUser = user;
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('user-info').style.display = 'flex';
            
            // Exibe nome ou email
            const name = user.displayName ? user.displayName.split(' ')[0] : "Usuário";
            document.getElementById('user-name').innerText = name;

            if(window.loadUserData) await window.loadUserData(user.uid);
        }
    });
</script>

<script src="script.js"></script>
</body>
</html>