<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Casa Nova</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body>

<div id="auth-overlay" class="auth-overlay">
    <div class="auth-box">
        <h2><i class="fas fa-home"></i> Casa Nova</h2>
        <p id="auth-msg">Fa√ßa login para continuar</p>
        <div class="auth-inputs">
            <input type="email" id="auth-email" placeholder="E-mail" class="auth-input">
            <input type="password" id="auth-pass" placeholder="Senha" class="auth-input">
        </div>
        <button id="btn-login-email" class="btn-auth-action">Entrar</button>
        <button id="btn-register-email" class="btn-auth-action" style="display:none;">Cadastrar</button>
        <div class="divider">ou</div>
        <button id="btn-login-google" class="btn-google"><i class="fab fa-google"></i> Entrar com Google</button>
        <div class="auth-toggle"><span id="toggle-text">N√£o tem conta?</span> <a href="#" id="toggle-auth">Criar conta</a></div>
    </div>
</div>

<header>
    <h1><i class="fas fa-home"></i> Gest√£o de Casa</h1>
    <div id="user-info" style="display:none; align-items:center; gap:10px;">
        <span id="user-name" style="color:var(--accent-color); font-weight:bold;">Usu√°rio</span>
        <button onclick="logout()" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Sair</button>
    </div>
</header>

<div id="app-content" style="display:none;">
    <div class="dashboard-area">
        <div class="dashboard-card wallet-card">
            <div class="card-title"><i class="fas fa-wallet"></i> Carteira (Dinheiro)</div>
            <div class="wallet-display">
                <span class="wallet-label">Dispon√≠vel</span>
                <span class="wallet-value" id="wallet-balance">R$ 0,00</span>
            </div>
            <div class="wallet-controls">
                <input type="text" id="trans-desc" placeholder="Descri√ß√£o">
                <input type="number" id="trans-val" placeholder="Valor (R$)" step="0.01">
                <div class="wallet-buttons">
                    <button class="btn-deposit" onclick="handleTransaction('add')"><i class="fas fa-arrow-up"></i></button>
                    <button class="btn-withdraw" onclick="handleTransaction('remove')"><i class="fas fa-arrow-down"></i></button>
                </div>
            </div>
            <ul id="wallet-history" class="wallet-history"></ul>
        </div>

        <div class="dashboard-card crypto-card">
            <div class="card-title">
                <i class="fab fa-bitcoin"></i> Criptoativos
                <button onclick="refreshCryptoPrices()" class="refresh-btn" title="Atualizar Cota√ß√£o"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div class="wallet-display" style="background:#222; border:1px solid #f3ba2f;">
                <span class="wallet-label">Total Convertido</span>
                <span class="wallet-value" id="crypto-total-brl" style="color:#f3ba2f;">R$ 0,00</span>
            </div>
            <div class="wallet-controls">
                <select id="crypto-select" class="auth-input" style="margin-bottom:5px;">
                    <option value="bitcoin">Bitcoin (BTC)</option>
                    <option value="ethereum">Ethereum (ETH)</option>
                    <option value="solana">Solana (SOL)</option>
                    <option value="tether">Tether (USDT)</option>
                    <option value="ripple">XRP</option>
                </select>
                <input type="number" id="crypto-amount" placeholder="Quantidade" step="0.000001">
                <button class="btn-deposit" onclick="addCrypto()" style="width:100%; margin-top:5px; background:#f3ba2f; color:black;">Adicionar Ativo</button>
            </div>
            <ul id="crypto-list" class="wallet-history"></ul>
        </div>

        <div class="dashboard-card progress-card">
            <div class="card-title"><i class="fas fa-chart-pie"></i> Progresso</div>
            
            <div class="progress-group">
                <div class="prog-label"><span style="color:var(--accent-color)">Cobertura Essencial</span><span id="prog-text-ess-cover">0%</span></div>
                <div class="progress-track"><div class="progress-fill fill-ess-cover" id="bar-ess-cover" style="width: 0%"></div></div>
                <div class="prog-details"><small style="color:#888;">Dinheiro cobre itens essenciais?</small></div>
            </div>

            <div class="progress-group">
                <div class="prog-label"><span>Financeiro Geral (Pago)</span><span id="prog-text-finance">0%</span></div>
                <div class="progress-track"><div class="progress-fill fill-finance" id="bar-finance" style="width: 0%"></div></div>
                <div class="prog-details"><span class="c-green" id="val-paid">Pago: R$ 0</span><span class="c-red" id="val-pending">Falta: R$ 0</span></div>
            </div>
            
            <div class="progress-group">
                <div class="prog-label"><span>Poder Total (Cobre tudo?)</span><span id="prog-text-cover">0%</span></div>
                <div class="progress-track"><div class="progress-fill fill-cover" id="bar-cover" style="width: 0%"></div></div>
            </div>
        </div>

        <div class="dashboard-card totals-card">
            <div class="card-title"><i class="fas fa-calculator"></i> Custos Projeto</div>
            <div id="dynamic-totals-container"></div>
            <div class="total-row main-total"><span>TOTAL GERAL:</span> <strong id="gl-total" style="color:var(--accent-color)">R$ 0,00</strong></div>
        </div>
    </div>

    <div class="room-nav-container">
        <nav class="room-nav" id="room-nav"></nav>
    </div>

    <div id="room-area-wrapper">
        <div class="container" id="main-container"></div>
    </div>
</div>

<div id="new-room-modal" class="auth-overlay" style="display:none;">
    <div class="auth-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0;">Novo C√¥modo</h2>
            <span onclick="document.getElementById('new-room-modal').style.display='none'" style="cursor:pointer; font-size:1.5rem;">&times;</span>
        </div>
        <input type="text" id="modal-room-name" class="auth-input" placeholder="Nome (ex: Quarto Gamer)" oninput="updateRoomPreview()">
        <div class="color-picker-group">
            <div style="flex:1;">
                <label style="font-size:0.8rem; color:#888;">Cor do Fundo</label>
                <input type="color" id="modal-room-bg" value="#19191a" style="width:100%; height:40px; border:none; border-radius:4px;" oninput="updateRoomPreview()">
            </div>
            <div style="flex:1;">
                <label style="font-size:0.8rem; color:#888;">Cor da Letra</label>
                <input type="color" id="modal-room-text" value="#888888" style="width:100%; height:40px; border:none; border-radius:4px;" oninput="updateRoomPreview()">
            </div>
        </div>
        <div style="margin: 20px 0; text-align:center;">
            <span style="font-size:0.8rem; color:#aaa; display:block; margin-bottom:5px;">Pr√©via:</span>
            <div id="room-preview-box" class="room-preview">Nome do C√¥modo</div>
        </div>
        <button onclick="saveNewRoom()" class="btn-auth-action">Criar C√¥modo</button>
    </div>
</div>

<div id="new-list-modal" class="auth-overlay" style="display:none;">
    <div class="auth-box" style="max-width: 500px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0;">Nova Lista de Itens</h2>
            <span onclick="document.getElementById('new-list-modal').style.display='none'" style="cursor:pointer; font-size:1.5rem;">&times;</span>
        </div>
        <input type="text" id="modal-list-name" class="auth-input" placeholder="Nome da Lista (ex: Gamer, Decora√ß√£o)">
        
        <div style="text-align:left; margin: 15px 0; background:#222; padding:15px; border-radius:8px;">
            <label style="display:block; margin-bottom:10px; color:#fff; font-weight:bold;">Onde adicionar esta lista?</label>
            
            <div style="margin-bottom:8px;">
                <input type="radio" name="add-list-target" value="current" id="target-current" checked onclick="toggleListSelection(this.value)">
                <label for="target-current" style="color:#ddd;">1. Adicionar apenas neste c√¥modo</label>
            </div>
            
            <div style="margin-bottom:8px;">
                <input type="radio" name="add-list-target" value="global" id="target-global" onclick="toggleListSelection(this.value)">
                <label for="target-global" style="color:#ddd;">2. Adicionar em TODOS os c√¥modos</label>
            </div>

             <div style="margin-bottom:8px;">
                <input type="radio" name="add-list-target" value="select" id="target-select" onclick="toggleListSelection(this.value)">
                <label for="target-select" style="color:#ddd; font-weight:bold; color:var(--accent-color);">3. Selecionar os c√¥modos...</label>
            </div>
            
            <div id="manual-selection-wrapper" style="display:none; margin-top:10px; border-top:1px solid #444; padding-top:10px;">
                <div class="room-selector-header" onclick="toggleRoomDropdown()">
                    <span><i class="fas fa-list"></i> Escolher C√¥modos</span>
                    <i class="fas fa-chevron-down" id="selector-arrow" style="transition:0.3s;"></i>
                </div>
                
                <div id="room-selection-container" style="display:none; margin-top:10px; background: #111; border-radius:5px; padding:10px; max-height:200px; overflow-y:auto; border:1px solid #444;">
                    </div>
            </div>
        </div>

        <button onclick="saveNewList()" class="btn-auth-action">OK (Criar Lista)</button>
    </div>
</div>

<div id="edit-modal" class="auth-overlay" style="display:none; align-items:flex-start; padding-top:50px; overflow-y:auto;">
    <div class="auth-box" style="text-align: left; max-width: 500px; width:95%; margin-bottom:50px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
            <h2 style="margin:0; font-size:1.2rem;">‚úèÔ∏è Editar Item</h2>
            <span onclick="closeEditModal()" style="cursor:pointer; font-size:1.5rem; color:#fff;">&times;</span>
        </div>
        <input type="hidden" id="edit-r-origin">
        <input type="hidden" id="edit-c-origin">
        <input type="hidden" id="edit-id">
        <label style="color:var(--accent-color); font-size:0.8rem; font-weight:bold;">Nome do Item</label>
        <input type="text" id="edit-name" class="auth-input" style="margin-bottom:15px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div>
                <label style="color:#888; font-size:0.8rem;">Pre√ßo (R$)</label>
                <input type="number" id="edit-price" class="auth-input" style="margin-bottom:15px;" step="0.01">
            </div>
            <div>
                <label style="color:#888; font-size:0.8rem;">Link / URL</label>
                <input type="text" id="edit-link" class="auth-input" style="margin-bottom:15px;">
            </div>
        </div>
        <label style="color:#888; font-size:0.8rem;">Descri√ß√£o</label>
        <textarea id="edit-desc" class="auth-input" style="margin-bottom:15px; height:80px; resize:none;"></textarea>
        <div style="background:#222; padding:15px; border-radius:8px; border:1px solid #333; margin-bottom:15px;">
            <label style="color:#fff; font-size:0.8rem; display:block; margin-bottom:10px;">üì∏ Galeria:</label>
            <div id="edit-gallery-container" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;"></div>
            <input type="file" id="edit-add-img-input" accept="image/*" multiple style="display:none">
            <label for="edit-add-img-input" class="file-upload-btn" style="width:100%;"><i class="fas fa-plus"></i> Adicionar Mais Fotos</label>
        </div>
        <div style="background:#222; padding:15px; border-radius:8px; border:1px dashed #444; margin-bottom:20px;">
            <label style="color:var(--accent-color); font-size:0.8rem; display:block; margin-bottom:10px;">üì¶ Mover:</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <span style="font-size:0.7rem; color:#888;">C√¥modo</span>
                    <select id="edit-move-room" class="auth-input" style="cursor:pointer;"></select>
                </div>
                <div>
                    <span style="font-size:0.7rem; color:#888;">Lista/Categoria</span>
                    <select id="edit-move-cat" class="auth-input" style="cursor:pointer;"></select>
                </div>
            </div>
        </div>
        <button onclick="saveEditItem()" class="btn-auth-action" style="background:var(--success-color); color:#000;">Salvar Altera√ß√µes</button>
        <button onclick="closeEditModal()" class="btn-auth-action" style="background:#333; margin-top:10px;">Cancelar</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD4cf7vaS03FfF-Yq8qFAeXh7xFqHjTZvY",
      authDomain: "gerenciador-casa-nova-995be.firebaseapp.com",
      projectId: "gerenciador-casa-nova-995be",
      storageBucket: "gerenciador-casa-nova-995be.firebasestorage.app",
      messagingSenderId: "445897682000",
      appId: "1:445897682000:web:6b715606cd666653c3b555",
      measurementId: "G-23EQ6DCPEJ"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    window.db = db; window.auth = auth; window.doc = doc; window.getDoc = getDoc; window.setDoc = setDoc; window.currentUser = null;

    const btnLogin = document.getElementById('btn-login-google');
    const overlay = document.getElementById('auth-overlay');
    const appContent = document.getElementById('app-content');
    const userNameSpan = document.getElementById('user-name');
    const emailInput = document.getElementById('auth-email');
    const passInput = document.getElementById('auth-pass');
    let isLoginMode = true;

    document.getElementById('toggle-auth').addEventListener('click', (e) => {
        e.preventDefault(); isLoginMode = !isLoginMode;
        document.getElementById('btn-login-email').style.display = isLoginMode ? 'block' : 'none';
        document.getElementById('btn-register-email').style.display = isLoginMode ? 'none' : 'block';
        document.getElementById('toggle-text').innerText = isLoginMode ? "N√£o tem conta?" : "J√° tem conta?";
        document.getElementById('toggle-auth').innerText = isLoginMode ? "Criar conta" : "Fazer login";
    });

    document.getElementById('btn-login-email').addEventListener('click', () => {
        signInWithEmailAndPassword(auth, emailInput.value, passInput.value).catch(e => alert(e.message));
    });
    document.getElementById('btn-register-email').addEventListener('click', () => {
        createUserWithEmailAndPassword(auth, emailInput.value, passInput.value).catch(e => alert(e.message));
    });
    btnLogin.addEventListener('click', () => signInWithPopup(auth, provider).catch(e => alert(e.message)));
    window.logout = () => signOut(auth).then(() => location.reload());

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            window.currentUser = user;
            overlay.style.display = 'none';
            appContent.style.display = 'block';
            document.getElementById('user-info').style.display = 'flex';
            userNameSpan.innerText = user.displayName ? user.displayName.split(' ')[0] : (user.email ? user.email.split('@')[0] : "Usu√°rio");
            if(window.loadUserData) await window.loadUserData(user.uid);
        }
    });
</script>
<script src="script.js"></script>
</body>
</html>